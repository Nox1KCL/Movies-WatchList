<!doctype html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Watchlist üçø</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0f172a;
        color: #e2e8f0;
      }

      .card {
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      }

      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>

  <body class="p-6">
    <div id="app" class="max-w-6xl mx-auto">
      <!-- AUTH SCREEN -->
      <div
        v-if="!isAuthenticated"
        class="min-h-screen flex items-center justify-center -mt-6"
      >
        <div
          class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md"
        >
          <div class="text-center mb-8">
            <h1
              class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2"
            >
              Movie Watchlist üçø
            </h1>
            <p class="text-slate-400 text-sm">{{ authMode === "login" ? "–£–≤—ñ–π–¥–∏ –≤ —Å–≤—ñ–π –∞–∫–∞—É–Ω—Ç" : "–°—Ç–≤–æ—Ä–∏ –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç" }}</p>
          </div>

          <!-- Auth Tabs -->
          <div class="flex mb-6 bg-slate-900 rounded-lg p-1">
            <button
              @click="authMode = 'login'"
              :class="authMode === 'login' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'"
              class="flex-1 py-2 px-4 rounded-md font-semibold transition"
            >
              –í—Ö—ñ–¥
            </button>
            <button
              @click="authMode = 'register'"
              :class="authMode === 'register' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'"
              class="flex-1 py-2 px-4 rounded-md font-semibold transition"
            >
              –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
            </button>
          </div>

          <!-- Auth Form -->
          <form @submit.prevent="handleAuth" class="space-y-4">
            <div v-if="authMode === 'register'">
              <label class="block text-sm text-slate-400 mb-1"
                >–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label
              >
              <input
                v-model="authForm.username"
                type="text"
                required
                placeholder="username"
                class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 outline-none text-white"
              />
            </div>

            <div>
              <label class="block text-sm text-slate-400 mb-1">Email</label>
              <input
                v-model="authForm.email"
                type="email"
                required
                placeholder="your@email.com"
                class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 outline-none text-white"
              />
            </div>

            <div>
              <label class="block text-sm text-slate-400 mb-1">–ü–∞—Ä–æ–ª—å</label>
              <input
                v-model="authForm.password"
                type="password"
                required
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 outline-none text-white"
              />
            </div>

            <!-- Error Message -->
            <div
              v-if="authError"
              class="bg-red-900/30 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg text-sm"
            >
              {{ authError }}
            </div>

            <!-- Success Message -->
            <div
              v-if="authSuccess"
              class="bg-green-900/30 border border-green-500/50 text-green-400 px-4 py-3 rounded-lg text-sm"
            >
              {{ authSuccess }}
            </div>

            <button
              type="submit"
              :disabled="authLoading"
              class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:opacity-50 text-white py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2"
            >
              <span v-if="authLoading" class="animate-spin">‚è≥</span>
              {{ authMode === 'login' ? '–£–≤—ñ–π—Ç–∏' : '–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è' }}
            </button>
          </form>
        </div>
      </div>

      <!-- MAIN APP (when authenticated) -->
      <div v-else>
        <header class="mb-10 flex justify-between items-center">
          <div class="text-center flex-1">
            <h1
              class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2"
            >
              Movie Watchlist
            </h1>
            <p class="text-slate-400">–¢–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É</p>
          </div>

          <!-- User Info & Logout -->
          <div class="flex items-center gap-4">
            <span class="text-slate-400 text-sm hidden md:block"
              >{{ userEmail }}</span
            >
            <button
              @click="logout"
              class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2"
            >
              <span>üö™</span>
              <span class="hidden md:inline">–í–∏–π—Ç–∏</span>
            </button>
          </div>
        </header>

        <div
          class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8 border border-slate-700"
        >
          <div
            class="flex flex-col md:flex-row gap-4 justify-between items-end"
          >
            <div class="flex flex-wrap gap-3 w-full md:w-auto">
              <div>
                <label class="text-xs font-semibold text-slate-400 uppercase"
                  >–°—Ç–∞—Ç—É—Å</label
                >
                <select
                  v-model="filters.status"
                  @change="fetchMovies"
                  class="block w-full mt-1 bg-slate-900 border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-purple-500 outline-none"
                >
                  <option value="">–í—Å—ñ</option>
                  <option value="want_to_watch">–•–æ—á—É –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å</option>
                  <option value="watching">–î–∏–≤–ª—é—Å—å</option>
                  <option value="watched">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</option>
                </select>
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-400 uppercase"
                  >–†—ñ–∫</label
                >
                <input
                  v-model="filters.year"
                  @input="debounceFetch"
                  type="number"
                  placeholder="2024"
                  class="block w-24 mt-1 bg-slate-900 border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-purple-500 outline-none text-white appearance-none"
                />
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-400 uppercase"
                  >–ñ–∞–Ω—Ä</label
                >
                <input
                  v-model="filters.genre"
                  @input="debounceFetch"
                  placeholder="–ü–æ—à—É–∫ –∂–∞–Ω—Ä—É..."
                  class="block w-full mt-1 bg-slate-900 border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-purple-500 outline-none text-white"
                />
              </div>
            </div>

            <button
              @click="openModal('add')"
              class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-lg transition flex items-center gap-2 w-full md:w-auto justify-center"
            >
              <span>+ –î–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å–º</span>
            </button>
          </div>
        </div>

        <div
          v-if="loading"
          class="text-center py-20 text-slate-500 animate-pulse"
        >
          –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>

        <div
          v-else-if="movies.length === 0"
          class="text-center py-20 text-slate-500"
        >
          <p class="text-xl">–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π üòî</p>
          <p class="text-sm">–°–ø—Ä–æ–±—É–π –∑–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ñ—ñ–ª—å–º.</p>
        </div>

        <div
          v-else
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <div
            v-for="movie in movies"
            :key="movie.id"
            class="card bg-slate-800 rounded-xl overflow-hidden border border-slate-700 relative group flex flex-col h-full"
          >
            <!-- –ü–æ—Å—Ç–µ—Ä -->
            <div v-if="movie.poster_url" class="relative h-48 overflow-hidden shrink-0">
              <img 
                :src="movie.poster_url" 
                :alt="movie.title"
                class="w-full h-full object-cover"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-slate-800 via-transparent to-transparent"></div>
            </div>
            
            <div class="p-5 flex flex-col flex-1">
              <div class="flex justify-between items-start mb-4">
                <!-- –õ—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞: –ù–∞–∑–≤–∞ —Ç–∞ –ñ–∞–Ω—Ä -->
                <div class="pr-4">
                  <h3 class="text-xl font-bold text-white leading-tight mb-1">
                    {{ movie.title }}
                  </h3>
                  <p class="text-purple-400 text-sm font-medium">
                    {{ movie.genre }}
                  </p>
                </div>

                <!-- –ü—Ä–∞–≤–∞ —á–∞—Å—Ç–∏–Ω–∞: –°—Ç–∞—Ç—É—Å —Ç–∞ –†—ñ–∫ -->
                <div class="flex flex-col items-end shrink-0">
                  <div
                    class="px-3 py-1 rounded-full text-xs font-bold uppercase shadow-sm mb-2"
                    :class="statusColor(movie.status)"
                  >
                    {{ formatStatus(movie.status) }}
                  </div>
                  <span class="text-slate-500 font-mono text-sm"
                    >{{ movie.year }}</span
                  >
                </div>
              </div>

              <!-- Overview -->
              <p v-if="movie.overview" class="text-slate-400 text-sm line-clamp-2 mb-4">
                {{ movie.overview }}
              </p>

              <div class="flex gap-2 mt-auto pt-4 border-t border-slate-700">
                <button
                  v-if="movie.tmdb_id"
                  @click="showMovieDetails(movie)"
                  class="px-3 bg-purple-900/30 hover:bg-purple-900/50 text-purple-400 rounded transition"
                  title="–î–µ—Ç–∞–ª—ñ"
                >
                  ‚ÑπÔ∏è
                </button>
                <button
                  @click="openModal('edit', movie)"
                  class="flex-1 bg-slate-700 hover:bg-slate-600 text-sm py-2 rounded transition"
                >
                  –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                </button>
                <button
                  type="button"
                  @click.stop="deleteMovie(movie.id)"
                  class="px-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded transition"
                  title="–í–∏–¥–∞–ª–∏—Ç–∏"
                >
                  ‚úï
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Movie Modal -->
        <div
          v-if="showModal"
          class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
        >
          <div
            class="bg-slate-800 rounded-2xl w-full max-w-md shadow-2xl border border-slate-600 transform transition-all"
          >
            <div class="p-6">
              <h2 class="text-2xl font-bold mb-6 text-white">
                {{ modalMode === 'add' ? '–ù–æ–≤–∏–π —Ñ—ñ–ª—å–º' : '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è' }}
              </h2>

              <form @submit.prevent="submitForm" class="space-y-4">
                <!-- TMDB Search (only for add mode) -->
                <div v-if="modalMode === 'add'" class="mb-4">
                  <label class="block text-sm text-slate-400 mb-1">üîç –ü–æ—à—É–∫ —É TMDB</label>
                  <input
                    v-model="tmdbQuery"
                    @input="searchTMDB"
                    type="text"
                    placeholder="–ü–æ—á–Ω–∏ –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É —Ñ—ñ–ª—å–º—É..."
                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                  />
                  <!-- Loading -->
                  <div v-if="tmdbLoading" class="text-center py-2 text-slate-400 text-sm">
                    –ü–æ—à—É–∫...
                  </div>
                  <!-- Results -->
                  <div v-if="tmdbResults.length > 0" class="mt-2 max-h-48 overflow-y-auto bg-slate-900 rounded border border-slate-600">
                    <div
                      v-for="movie in tmdbResults.slice(0, 6)"
                      :key="movie.tmdb_id"
                      @click="selectTMDBMovie(movie)"
                      class="flex items-center gap-3 p-2 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-0"
                    >
                      <img
                        v-if="movie.poster_url"
                        :src="movie.poster_url"
                        class="w-10 h-14 object-cover rounded"
                        :alt="movie.title"
                      />
                      <div v-else class="w-10 h-14 bg-slate-700 rounded flex items-center justify-center text-xs text-slate-500">
                        üé¨
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-white text-sm font-medium truncate">{{ movie.title }}</p>
                        <p class="text-slate-400 text-xs">{{ movie.year || 'N/A' }}</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-slate-400 mb-1">–ù–∞–∑–≤–∞</label>
                  <input
                    v-model="form.title"
                    required
                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                  />
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-slate-400 mb-1">–†—ñ–∫</label>
                    <input
                      v-model.number="form.year"
                      type="number"
                      required
                      class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                    />
                  </div>
                  <div>
                    <label class="block text-sm text-slate-400 mb-1"
                      >–ñ–∞–Ω—Ä</label
                    >
                    <input
                      v-model="form.genre"
                      required
                      class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                    />
                  </div>
                </div>

                <div>
                  <label class="block text-sm text-slate-400 mb-1"
                    >–°—Ç–∞—Ç—É—Å</label
                  >
                  <select
                    v-model="form.status"
                    required
                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                  >
                    <option value="want_to_watch">–•–æ—á—É –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å</option>
                    <option value="watching">–î–∏–≤–ª—é—Å—å</option>
                    <option value="watched">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</option>
                  </select>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                  <button
                    type="button"
                    @click="closeModal"
                    class="px-4 py-2 text-slate-400 hover:text-white transition"
                  >
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                  </button>
                  <button
                    type="submit"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition"
                  >
                    {{ modalMode === 'add' ? '–°—Ç–≤–æ—Ä–∏—Ç–∏' : '–ó–±–µ—Ä–µ–≥—Ç–∏' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

        <!-- Movie Details Modal -->
        <div
          v-if="showDetailsModal"
          class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
          @click.self="closeDetailsModal"
        >
          <div class="bg-slate-800 rounded-2xl w-full max-w-2xl shadow-2xl border border-slate-600 overflow-hidden">
            <!-- Loading -->
            <div v-if="detailsLoading" class="p-12 text-center">
              <div class="text-4xl mb-4">üé¨</div>
              <p class="text-slate-400">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
            
            <!-- Content -->
            <div v-else-if="movieDetails" class="flex flex-col md:flex-row">
              <!-- Poster -->
              <div class="md:w-1/3 shrink-0">
                <img 
                  v-if="movieDetails.poster_url"
                  :src="movieDetails.poster_url"
                  :alt="movieDetails.title"
                  class="w-full h-64 md:h-full object-cover"
                />
                <div v-else class="w-full h-64 md:h-full bg-slate-700 flex items-center justify-center text-6xl">
                  üé¨
                </div>
              </div>
              
              <!-- Info -->
              <div class="p-6 flex-1">
                <button 
                  @click="closeDetailsModal" 
                  class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl"
                >‚úï</button>
                
                <h2 class="text-2xl font-bold text-white mb-1">{{ movieDetails.title }}</h2>
                <p v-if="movieDetails.original_title && movieDetails.original_title !== movieDetails.title" class="text-slate-400 text-sm mb-2">
                  {{ movieDetails.original_title }}
                </p>
                <p v-if="movieDetails.tagline" class="text-purple-400 italic mb-4">
                  "{{ movieDetails.tagline }}"
                </p>
                
                <!-- Meta Info -->
                <div class="flex flex-wrap gap-2 mb-4 text-sm">
                  <span class="bg-purple-900/50 text-purple-300 px-2 py-1 rounded">
                    {{ movieDetails.year }}
                  </span>
                  <span v-if="movieDetails.runtime" class="bg-slate-700 text-slate-300 px-2 py-1 rounded">
                    {{ movieDetails.runtime }} —Ö–≤
                  </span>
                  <span v-if="movieDetails.vote_average" class="bg-yellow-900/50 text-yellow-300 px-2 py-1 rounded">
                    ‚≠ê {{ movieDetails.vote_average.toFixed(1) }}
                  </span>
                </div>
                
                <!-- Genres -->
                <div v-if="movieDetails.genre" class="mb-4">
                  <span class="text-sm text-slate-500">–ñ–∞–Ω—Ä–∏:</span>
                  <span class="text-slate-300 ml-2">{{ movieDetails.genre }}</span>
                </div>
                
                <!-- Directors -->
                <div v-if="movieDetails.directors && movieDetails.directors.length" class="mb-4">
                  <span class="text-sm text-slate-500">–†–µ–∂–∏—Å–µ—Ä:</span>
                  <span class="text-slate-300 ml-2">{{ movieDetails.directors.join(', ') }}</span>
                </div>
                
                <!-- Cast -->
                <div v-if="movieDetails.cast && movieDetails.cast.length" class="mb-4">
                  <span class="text-sm text-slate-500">–ê–∫—Ç–æ—Ä–∏:</span>
                  <span class="text-slate-300 ml-2">{{ movieDetails.cast.join(', ') }}</span>
                </div>
                
                <!-- Overview -->
                <!-- Overview -->
                <div class="mt-4">
                  <p v-if="movieDetails.overview" class="text-slate-400 text-sm leading-relaxed">{{ movieDetails.overview }}</p>
                  <p v-else class="text-slate-600 text-sm italic">–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;
      const API_URL = "http://127.0.0.1:8000";

      createApp({
        data() {
          return {
            // Auth state
            isAuthenticated: false,
            authMode: "login", // 'login' or 'register'
            authForm: {
              email: "",
              username: "",
              password: "",
            },
            authError: "",
            authSuccess: "",
            authLoading: false,
            token: null,
            userEmail: "",

            // Movies state
            movies: [],
            loading: true,
            filters: {
              status: "",
              genre: "",
              year: null,
            },
            showModal: false,
            modalMode: "add",
            currentId: null,
            form: {
              title: "",
              year: new Date().getFullYear(),
              genre: "",
              status: "want_to_watch",
              tmdb_id: null,
              poster_url: "",
              overview: "",
              original_title: "",
            },
            debounceTimer: null,
            // TMDB Search
            tmdbQuery: "",
            tmdbResults: [],
            tmdbLoading: false,
            tmdbSearchTimer: null,
            
            // Movie Details Modal
            showDetailsModal: false,
            movieDetails: null,
            detailsLoading: false,
          };
        },
        mounted() {
          // Check for existing token
          const savedToken = localStorage.getItem("token");
          const savedEmail = localStorage.getItem("userEmail");
          if (savedToken) {
            this.token = savedToken;
            this.userEmail = savedEmail || "";
            this.isAuthenticated = true;
            this.fetchMovies();
          }
        },
        methods: {
          // ========== AUTH METHODS ==========
          async handleAuth() {
            this.authError = "";
            this.authSuccess = "";
            this.authLoading = true;

            try {
              if (this.authMode === "register") {
                await this.register();
              } else {
                await this.login();
              }
            } catch (error) {
              this.authError = error.message || "–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫";
            } finally {
              this.authLoading = false;
            }
          },

          async register() {
            const res = await fetch(`${API_URL}/auth/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: this.authForm.email,
                username: this.authForm.username,
                password: this.authForm.password,
              }),
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.detail || "–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó");
            }

            this.authSuccess = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.";
            this.authMode = "login";
            this.authForm.username = "";
          },

          async login() {
            // OAuth2 requires form data, not JSON
            const formData = new URLSearchParams();
            formData.append("username", this.authForm.email); // OAuth2 uses "username" field
            formData.append("password", this.authForm.password);

            const res = await fetch(`${API_URL}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: formData,
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.detail || "–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å");
            }

            // Save token
            this.token = data.access_token;
            this.userEmail = this.authForm.email;
            localStorage.setItem("token", this.token);
            localStorage.setItem("userEmail", this.userEmail);

            this.isAuthenticated = true;
            this.fetchMovies();
          },

          logout() {
            this.token = null;
            this.userEmail = "";
            this.isAuthenticated = false;
            this.movies = [];
            localStorage.removeItem("token");
            localStorage.removeItem("userEmail");

            // Reset auth form
            this.authForm = { email: "", username: "", password: "" };
            this.authError = "";
            this.authSuccess = "";
          },

          // Helper for authorized requests
          getAuthHeaders() {
            return {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.token}`,
            };
          },

          // ========== MOVIE METHODS ==========
          async fetchMovies() {
            this.loading = true;
            try {
              const params = new URLSearchParams();
              if (this.filters.status)
                params.append("status", this.filters.status);
              if (this.filters.genre)
                params.append("genre", this.filters.genre);
              if (this.filters.year) params.append("year", this.filters.year);

              const res = await fetch(
                `${API_URL}/movies/?${params.toString()}`,
                {
                  headers: this.getAuthHeaders(),
                },
              );

              if (res.status === 401) {
                this.logout();
                return;
              }

              if (res.ok) {
                this.movies = await res.json();
              }
            } catch (error) {
              console.error("Error loading movies:", error);
            } finally {
              this.loading = false;
            }
          },

          debounceFetch() {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
              this.fetchMovies();
            }, 500);
          },

          openModal(mode, movie = null) {
            this.modalMode = mode;
            if (mode === "edit" && movie) {
              this.currentId = movie.id;
              this.form = { ...movie };
            } else {
              this.currentId = null;
              this.form = {
                title: "",
                year: new Date().getFullYear(),
                genre: "",
                status: "want_to_watch",
                tmdb_id: null,
                poster_url: "",
                overview: "",
                original_title: "",
              };
            }
            this.showModal = true;
            this.tmdbQuery = "";
            this.tmdbResults = [];
          },

          closeModal() {
            this.showModal = false;
          },

          async submitForm() {
            try {
              const method = this.modalMode === "add" ? "POST" : "PATCH";
              const url =
                this.modalMode === "add"
                  ? `${API_URL}/movies/`
                  : `${API_URL}/movies/${this.currentId}`;

              const res = await fetch(url, {
                method: method,
                headers: this.getAuthHeaders(),
                body: JSON.stringify(this.form),
              });

              if (res.status === 401) {
                this.logout();
                return;
              }

              if (res.ok) {
                this.closeModal();
                this.fetchMovies();
              } else {
                const data = await res.json();
                alert(data.detail || "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");
              }
            } catch (e) {
              console.error(e);
              alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");
            }
          },

          async deleteMovie(id) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ—ñ–ª—å–º?')) return;
            
            try {
              const res = await fetch(`${API_URL}/movies/${id}`, {
                method: "DELETE",
                headers: this.getAuthHeaders(),
              });

              if (res.status === 401) {
                this.logout();
                return;
              }

              this.fetchMovies();
            } catch (e) {
              console.error(e);
            }
          },

          statusColor(status) {
            const colors = {
              want_to_watch: "bg-blue-500/20 text-blue-300",
              watching: "bg-yellow-500/20 text-yellow-300",
              watched: "bg-green-500/20 text-green-300",
            };
            return colors[status] || "bg-gray-500/20";
          },
          formatStatus(status) {
            const map = {
              want_to_watch: "–£ –ø–ª–∞–Ω–∞—Ö",
              watching: "–î–∏–≤–ª—é—Å—å",
              watched: "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ",
            };
            return map[status] || status;
          },

          // ========== TMDB SEARCH METHODS ==========
          searchTMDB() {
            clearTimeout(this.tmdbSearchTimer);
            if (!this.tmdbQuery || this.tmdbQuery.length < 2) {
              this.tmdbResults = [];
              return;
            }
            this.tmdbSearchTimer = setTimeout(async () => {
              this.tmdbLoading = true;
              try {
                const res = await fetch(
                  `${API_URL}/movies/search?query=${encodeURIComponent(this.tmdbQuery)}`,
                  { headers: this.getAuthHeaders() }
                );
                if (res.ok) {
                  this.tmdbResults = await res.json();
                }
              } catch (e) {
                console.error("TMDB search error:", e);
              } finally {
                this.tmdbLoading = false;
              }
            }, 400);
          },

          async selectTMDBMovie(movie) {
            this.form.title = movie.title;
            this.form.original_title = movie.original_title || "";
            this.form.year = movie.year || new Date().getFullYear();
            this.form.tmdb_id = movie.tmdb_id;
            this.form.poster_url = movie.poster_url || "";
            this.form.overview = movie.overview || "";
            this.form.genre = movie.genre || "";
            
            this.tmdbQuery = "";
            this.tmdbResults = [];

            // Fetch full details to ensure genre and other fields are populated correctly
            if (movie.tmdb_id) {
              try {
                const res = await fetch(`${API_URL}/movies/tmdb/${movie.tmdb_id}`, {
                  headers: this.getAuthHeaders()
                });
                if (res.ok) {
                  const details = await res.json();
                  if (details.genre) this.form.genre = details.genre;
                  if (details.overview && !this.form.overview) this.form.overview = details.overview;
                  if (details.original_title) this.form.original_title = details.original_title;
                }
              } catch (e) {
                console.warn("Failed to fetch full details for autofill", e);
              }
            }
          },

          // ========== MOVIE DETAILS MODAL ==========
          async showMovieDetails(movie) {
            if (!movie.tmdb_id) return;
            
            this.showDetailsModal = true;
            this.detailsLoading = true;
            this.movieDetails = null;
            
            try {
              const res = await fetch(
                `${API_URL}/movies/tmdb/${movie.tmdb_id}`,
                { headers: this.getAuthHeaders() }
              );
              if (res.ok) {
                this.movieDetails = await res.json();
              }
            } catch (e) {
              console.error("Error fetching movie details:", e);
            } finally {
              this.detailsLoading = false;
            }
          },

          closeDetailsModal() {
            this.showDetailsModal = false;
            this.movieDetails = null;
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
