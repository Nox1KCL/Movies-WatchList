<!doctype html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Watchlist üçø</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0f172a;
        color: #e2e8f0;
      }

      .card {
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>

  <body class="p-6">
    <div id="app" class="max-w-6xl mx-auto">
      <header class="mb-10 text-center">
        <h1
          class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2"
        >
          Movie Watchlist
        </h1>
        <p class="text-slate-400">–¢–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É</p>
      </header>

      <div
        class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8 border border-slate-700"
      >
        <div class="flex flex-col md:flex-row gap-4 justify-between items-end">
          <div class="flex flex-wrap gap-3 w-full md:w-auto">
            <div>
              <label class="text-xs font-semibold text-slate-400 uppercase"
                >–°—Ç–∞—Ç—É—Å</label
              >
              <select
                v-model="filters.status"
                @change="fetchMovies"
                class="block w-full mt-1 bg-slate-900 border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-purple-500 outline-none"
              >
                <option value="">–í—Å—ñ</option>
                <option value="want_to_watch">–•–æ—á—É –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å</option>
                <option value="watching">–î–∏–≤–ª—é—Å—å</option>
                <option value="watched">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-400 uppercase"
                >–†—ñ–∫</label
              >
              <input
                v-model="filters.year"
                @input="debounceFetch"
                type="number"
                placeholder="2024"
                class="block w-24 mt-1 bg-slate-900 border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-purple-500 outline-none text-white appearance-none"
              />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-400 uppercase"
                >–ñ–∞–Ω—Ä</label
              >
              <input
                v-model="filters.genre"
                @input="debounceFetch"
                placeholder="–ü–æ—à—É–∫ –∂–∞–Ω—Ä—É..."
                class="block w-full mt-1 bg-slate-900 border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-purple-500 outline-none text-white"
              />
            </div>
          </div>

          <button
            @click="openModal('add')"
            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold shadow-lg transition flex items-center gap-2 w-full md:w-auto justify-center"
          >
            <span>+ –î–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å–º</span>
          </button>
        </div>
      </div>

      <div
        v-if="loading"
        class="text-center py-20 text-slate-500 animate-pulse"
      >
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
      </div>

      <div
        v-else-if="movies.length === 0"
        class="text-center py-20 text-slate-500"
      >
        <p class="text-xl">–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π üòî</p>
        <p class="text-sm">–°–ø—Ä–æ–±—É–π –∑–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ñ—ñ–ª—å–º.</p>
      </div>

      <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div
          v-for="movie in movies"
          :key="movie.id"
          class="card bg-slate-800 rounded-xl overflow-hidden border border-slate-700 relative group"
        >
          <div class="p-5 flex flex-col h-full">
            <div class="flex justify-between items-start mb-4">
              <!-- –õ—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞: –ù–∞–∑–≤–∞ —Ç–∞ –ñ–∞–Ω—Ä -->
              <div class="pr-4">
                <h3 class="text-xl font-bold text-white leading-tight mb-1">
                  {{ movie.title }}
                </h3>
                <p class="text-purple-400 text-sm font-medium">
                  {{ movie.genre }}
                </p>
              </div>

              <!-- –ü—Ä–∞–≤–∞ —á–∞—Å—Ç–∏–Ω–∞: –°—Ç–∞—Ç—É—Å —Ç–∞ –†—ñ–∫ -->
              <div class="flex flex-col items-end shrink-0">
                <div
                  class="px-3 py-1 rounded-full text-xs font-bold uppercase shadow-sm mb-2"
                  :class="statusColor(movie.status)"
                >
                  {{ formatStatus(movie.status) }}
                </div>
                <span class="text-slate-500 font-mono text-sm"
                  >{{ movie.year }}</span
                >
              </div>
            </div>

            <div class="flex gap-2 mt-4 pt-4 border-t border-slate-700">
              <button
                @click="openModal('edit', movie)"
                class="flex-1 bg-slate-700 hover:bg-slate-600 text-sm py-2 rounded transition"
              >
                –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
              </button>
              <button
                type="button"
                @click.stop="deleteMovie(movie.id)"
                class="px-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded transition"
                title="–í–∏–¥–∞–ª–∏—Ç–∏"
              >
                ‚úï
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        v-if="showModal"
        class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
      >
        <div
          class="bg-slate-800 rounded-2xl w-full max-w-md shadow-2xl border border-slate-600 transform transition-all"
        >
          <div class="p-6">
            <h2 class="text-2xl font-bold mb-6 text-white">
              {{ modalMode === 'add' ? '–ù–æ–≤–∏–π —Ñ—ñ–ª—å–º' : '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è' }}
            </h2>

            <form @submit.prevent="submitForm" class="space-y-4">
              <div>
                <label class="block text-sm text-slate-400 mb-1">–ù–∞–∑–≤–∞</label>
                <input
                  v-model="form.title"
                  required
                  class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-slate-400 mb-1">–†—ñ–∫</label>
                  <input
                    v-model.number="form.year"
                    type="number"
                    required
                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                  />
                </div>
                <div>
                  <label class="block text-sm text-slate-400 mb-1">–ñ–∞–Ω—Ä</label>
                  <input
                    v-model="form.genre"
                    required
                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm text-slate-400 mb-1">–°—Ç–∞—Ç—É—Å</label>
                <select
                  v-model="form.status"
                  required
                  class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-purple-500 outline-none text-white"
                >
                  <option value="want_to_watch">–•–æ—á—É –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å</option>
                  <option value="watching">–î–∏–≤–ª—é—Å—å</option>
                  <option value="watched">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ</option>
                </select>
              </div>

              <div class="flex justify-end gap-3 mt-8">
                <button
                  type="button"
                  @click="closeModal"
                  class="px-4 py-2 text-slate-400 hover:text-white transition"
                >
                  –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button
                  type="submit"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition"
                >
                  {{ modalMode === 'add' ? '–°—Ç–≤–æ—Ä–∏—Ç–∏' : '–ó–±–µ—Ä–µ–≥—Ç–∏' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;
      const API_URL = "http://127.0.0.1:8000/movies/";

      createApp({
        data() {
          return {
            movies: [],
            loading: true,
            filters: {
              status: "",
              genre: "",
              year: null,
            },
            showModal: false,
            modalMode: "add", // 'add' or 'edit'
            currentId: null,
            form: {
              title: "",
              year: new Date().getFullYear(),
              genre: "",
              status: "want_to_watch",
            },
            debounceTimer: null,
          };
        },
        mounted() {
          this.fetchMovies();
        },
        methods: {
          // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ—ñ–ª—å–º—ñ–≤ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é
          async fetchMovies() {
            this.loading = true;
            try {
              // –ë—É–¥—É—î–º–æ URL –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
              const params = new URLSearchParams();
              if (this.filters.status)
                params.append("status", this.filters.status);
              if (this.filters.genre)
                params.append("genre", this.filters.genre);
              if (this.filters.year) 
                params.append('year', this.filters.year);

              const res = await fetch(`${API_URL}?${params.toString()}`);
              if (res.ok) {
                this.movies = await res.json();
              }
            } catch (error) {
              console.error("Error loading movies:", error);
            } finally {
              this.loading = false;
            }
          },

          // –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–æ—à—É–∫—É –¥–ª—è input (—â–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏ –∑–∞–ø–∏—Ç–∞–º–∏)
          debounceFetch() {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
              this.fetchMovies();
            }, 500);
          },

          // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏
          openModal(mode, movie = null) {
            this.modalMode = mode;
            if (mode === "edit" && movie) {
              this.currentId = movie.id;
              this.form = { ...movie }; // –ö–æ–ø—ñ—é—î–º–æ –¥–∞–Ω—ñ
            } else {
              this.currentId = null;
              this.form = {
                title: "",
                year: 2024,
                genre: "",
                status: "want_to_watch",
              };
            }
            this.showModal = true;
          },

          closeModal() {
            this.showModal = false;
          },

          // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏ (–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è)
          async submitForm() {
            try {
              const method = this.modalMode === "add" ? "POST" : "PATCH";
              const url =
                this.modalMode === "add"
                  ? API_URL
                  : `${API_URL}${this.currentId}`;

              const res = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(this.form),
              });

              if (res.ok) {
                this.closeModal();
                this.fetchMovies(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
              } else {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");
              }
            } catch (e) {
              console.error(e);
            }
          },

          // –í–∏–¥–∞–ª–µ–Ω–Ω—è
          async deleteMovie(id) {
            // if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ—ñ–ª—å–º?")) return;

            try {
              await fetch(`${API_URL}${id}`, { method: "DELETE" });
              this.fetchMovies();
            } catch (e) {
              console.error(e);
            }
          },

          // –•–µ–ª–ø–µ—Ä–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          statusColor(status) {
            const colors = {
              want_to_watch: "bg-blue-500/20 text-blue-300",
              watching: "bg-yellow-500/20 text-yellow-300",
              watched: "bg-green-500/20 text-green-300",
            };
            return colors[status] || "bg-gray-500/20";
          },
          formatStatus(status) {
            const map = {
              want_to_watch: "–£ –ø–ª–∞–Ω–∞—Ö",
              watching: "–î–∏–≤–ª—é—Å—å",
              watched: "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–æ",
            };
            return map[status] || status;
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
